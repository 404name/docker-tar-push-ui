<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="./static/tailwind.min.css">
  <link rel="stylesheet" href="./static/xterm.css" />
  <script src="./static/xterm.js"></script>
  <script src="./static/axios.min.js"></script>
  <style>
    #commandInput {
        width: calc(100% - 50px); /* 输入框宽度 */
        padding: 10px; /* 内边距 */
        border: 1px solid #444; /* 边框 */
        background-color: #333; /* 输入框背景色 */
        color: #fff; /* 输入框文字颜色 */
    }
    #sendButton {
        padding: 10px; /* 内边距 */
        background-color: #007bff; /* 按钮背景色 */
        color: white; /* 按钮文字颜色 */
        border: none; /* 无边框 */
        cursor: pointer; /* 鼠标指针 */
    }
    #sendButton:hover {
        background-color: #0056b3; /* 悬停时的背景色 */
    }
  </style>
</head>
<body>
    <section class="p-6 bg-gray-100 text-gray-800">
        <div class="container grid gap-6 mx-auto text-center">
            <div class="w-full px-6 py-16 rounded-md sm:px-12 md:px-16 xl:col-span-2 bg-gray-50">
                <h2 class="text-5xl font-extrabold text-gray-900">镜像上传工具</h2>
                <div class="max-w overflow-hidden rounded-lg shadow-lg bg-gray-50 text-gray-800">
                    <div class="flex items-end justify-end h-32 p-4 bg-gray-500 bg-center bg-cover" style="background-image: url(https://code.sundray.com.cn/12626/img/raw/master/2023/09/5_15_27_30_Snipaste_2023-07-25_12-29-58.png);">
                        <p class="px-2 py-1 text-sm tracking-widest text-gray-100 uppercase bg-gray-800 bg-opacity-75 rounded shadow-lg">POWERD BY 12626</p>
                    </div>
                </div>
                <form novalidate="" action="" class="self-stretch space-y-3 my-4" enctype="multipart/form-data">
                    <fieldset class="w-full space-y-1 text-gray-800">
                        <div class="flex">
                            <span class="flex items-center px-3 pointer-events-none sm:text-sm rounded-l-md bg-gray-300">镜像仓库地址</span>
                            <input type="text" name="repo" id="repo" placeholder="仓库地址" class="flex flex-1 border sm:text-sm rounded-r-md focus:ring-inset border-gray-300 text-gray-800 bg-gray-100 focus:ring-indigo-600">
                        </div>
                    </fieldset>
                    <fieldset class="w-full space-y-1 text-gray-800">
                        <div class="flex">
                            <span class="flex items-center px-3 pointer-events-none sm:text-sm rounded-l-md bg-gray-300">账号</span>
                            <input type="text" name="username" id="username" placeholder="账号" class="flex flex-1 border sm:text-sm rounded-r-md focus:ring-inset border-gray-300 text-gray-800 bg-gray-100 focus:ring-indigo-600">
                        </div>
                    </fieldset>
                    <fieldset class="w-full space-y-1 text-gray-800">
                        <div class="flex">
                            <span class="flex items-center px-3 pointer-events-none sm:text-sm rounded-l-md bg-gray-300">密码</span>
                            <input type="password" name="password" id="password" placeholder="密码" class="flex flex-1 border sm:text-sm rounded-r-md focus:ring-inset border-gray-300 text-gray-800 bg-gray-100 focus:ring-indigo-600">
                        </div>
                    </fieldset>
                    <!-- <fieldset class="w-full space-y-1 text-gray-800">
                        <div class="flex">
                            <span class="flex items-center px-3 pointer-events-none sm:text-sm rounded-l-md bg-gray-300">CA证书</span>
                            <input type="file" name="caFile" id="caFile" class="flex flex-1 border sm:text-sm rounded-r-md focus:ring-inset border-gray-300 text-gray-800 bg-gray-100 focus:ring-indigo-600">
                        </div>
                    </fieldset> -->
                    <fieldset class="w-full space-y-1 text-gray-800">
                        <div class="flex">
                            <span class="flex items-center px-3 pointer-events-none sm:text-sm rounded-l-md bg-gray-300">离线镜像包</span>
                            <input type="file" name="imageFile" id="imageFile" class="flex flex-1 border sm:text-sm rounded-r-md focus:ring-inset border-gray-300 text-gray-800 bg-gray-100 focus:ring-indigo-600">
                        </div>
                    </fieldset>
                    <button type="button" onclick="uploadImage()" class="w-full py-2 font-semibold rounded text-gray-50 bg-indigo-600">上传镜像包</button>
                </form>
                <!-- Progress Bar -->
                <div id="progressWrapper" class="w-full bg-gray-200 rounded-full h-4 mt-4 hidden">
                    <div id="progressBar" class="bg-indigo-600 h-full rounded-full"></div>
                </div>
            </div>
        </div>
    </section>
    <div class="container p-2 mx-auto sm:p-4 text-gray-800">
        <h1 class="text-2xl font-bold mb-4">Docker Tar Push Terminal</h1>
        <div class="w-full h-408px">
            <div id="terminal" class="w-full h-full"></div>
        </div>
        <div class="flex">
            <input type="text" id="commandInput" placeholder="Type your command..." />
            <button id="sendButton">Send</button>
        </div>
    </div>
    <div class="container p-2 mx-auto sm:p-4 text-gray-800">
        <h2 class="mb-4 text-2xl font-semibold leading-tight">上传记录</h2>
        <div class="overflow-x-auto">
            <table id="recordTable" class="min-w-full text-xs">
                <colgroup>
                    <col>
                    <col>
                </colgroup>
                <thead class="bg-gray-300">
                    <tr class="text-left">
                        <th class="p-3">镜像名字</th>
                        <th class="p-3">镜像地址</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
    <section class="bg-gray-100 text-gray-800">
        <div class="container flex flex-col justify-center px-4 py-8 mx-auto md:p-8">
            <h2 class="text-2xl font-semibold sm:text-4xl">常见问题</h2>
            <p class="mt-4 mb-8 text-gray-600">常见的问题和解答。</p>
            <div class="space-y-4">
                <details class="w-full border rounded-lg">
                    <summary class="px-4 py-6 focus:outline-none focus-visible:ring-indigo-600">如何使用该工具？</summary>
                    <p class="px-4 py-6 pt-0 ml-4 -mt-4 text-gray-600">请按照页面上的指示填写镜像仓库地址、账号、密码，并上传CA证书和离线镜像包，然后点击“上传镜像包”按钮。</p>
                </details>
                <details class="w-full border rounded-lg">
                    <summary class="px-4 py-6 focus:outline-none focus-visible:ring-indigo-600">上传后的镜像如何查看？</summary>
                    <p class="px-4 py-6 pt-0 ml-4 -mt-4 text-gray-600">上传成功后，您可以在上传记录表格中查看镜像名字和镜像地址。</p>
                </details>
            </div>
        </div>
    </section>

    <script>
        const term = new Terminal();

        term.open(document.querySelector('#terminal')); // 挂载
        // 确保终端的大小为100%
        
        // 动态计算列数
        function resizeTerminal() {
            const terminalElement = document.getElementById('terminal');
            const width = terminalElement.getBoundingClientRect().width; // 获取容器宽度
            const charWidth = 9; // 每个字符的宽度（像素）
            const cols = Math.floor(width / charWidth) - 5; // 计算列数
            const rows = 24; // 设置行数
            term.resize(cols, rows); // 设置终端大小
        }
        //term.resize(80, 24); // 这里的 80 和 24 是默认的列数和行数
        window.addEventListener('resize', resizeTerminal);
        resizeTerminal(); // 初始化时调整终端大小
        const socket = new WebSocket(`ws://${window.location.host}/webterminal`); // 创建WebSocket连接
        const commandInput = document.getElementById("commandInput");
        const sendButton = document.getElementById("sendButton");

        // term.onData((data) => { // 网页xterm窗口中有输入的数据
        //     // console.log('term.onData:', data);
        //     socket.send(data); // 通过WebSocket发送给服务器
        // });

        socket.onmessage = (event) => { // 收到来自服务器的WebSocket消息  
            const data = event.data.replace(/\r?\n/g, '\r\n'); // 预处理换行符
            console.log('socket.onmessage:', event.data);
            term.write(data); // 向xterm对象写入数据
        };

        sendButton.addEventListener("click", function() {
            sendCommand();
        });

        // 允许按回车发送命令
        commandInput.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                sendCommand();
            }
        });

        function sendCommand() {
            const command = commandInput.value.trim();
            if (command) {
                socket.send(command); // 发送命令

                // ANSI 转义序列设置颜色
                const colorCode = "32"; // 绿色
                const resetCode = "0"; // 重置颜色

                // 使用 ANSI 转义序列写入命令
                term.write(`\x1b[${colorCode}m> ${command}\x1b[${resetCode}m\r\n`); // 向 xterm 对象写入数据
                commandInput.value = ""; // 清空输入框
            }
        }

        // // 上传镜像包
        // const outputElement = document.getElementById("output");
        // const commandInput = document.getElementById("commandInput");
        // const sendButton = document.getElementById("sendButton");

        // const socket = new WebSocket("ws://localhost:8080/ws");

        // socket.onopen = function() {
        //     console.log("WebSocket connection established.");
        //     outputElement.innerHTML += "<span>> </span>"; // 初始化提示符
        // };

        // socket.onmessage = function(event) {
        //     // 将接收到的消息中的换行符替换为 <br>
        //     const formattedMessage = event.data.replace(/\n/g, "<br>");
        //     outputElement.innerHTML += `<div>${formattedMessage}</div>`; // 显示输出
        //     outputElement.innerHTML += "<span>> </span>"; // 添加提示符
        //     outputElement.scrollTop = outputElement.scrollHeight; // 滚动到输出底部
        // };

        // sendButton.addEventListener("click", function() {
        //     sendCommand();
        // });

        // // 允许按回车发送命令
        // commandInput.addEventListener("keypress", function(event) {
        //     if (event.key === "Enter") {
        //         sendCommand();
        //     }
        // });

        // function sendCommand() {
        //     const command = commandInput.value.trim();
        //     if (command) {
        //         socket.send(command); // 发送命令
        //         commandInput.value = ""; // 清空输入框
        //     }
        // }

        function uploadImage() {
            const repo = document.getElementById('repo').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            // const caFile = document.getElementById('caFile').files[0];
            const imageFile = document.getElementById('imageFile').files[0];
            const url = '/upload';

            const formData = new FormData();
            formData.append('repo', repo);
            formData.append('username', username);
            formData.append('password', password);
            // formData.append('caFile', caFile);
            formData.append('imageFile', imageFile);

            const progressWrapper = document.getElementById('progressWrapper');
            const progressBar = document.getElementById('progressBar');

            progressWrapper.classList.remove('hidden');

            axios.post(url, formData, {
                onUploadProgress: function(progressEvent) {
                    if (progressEvent.lengthComputable) {
                        let percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                        progressBar.style.width = percentCompleted + '%';
                    }
                }
            })
                .then(response => {
                    alert('上传成功！');
                    getData();
                    progressWrapper.classList.add('hidden');
                })
                .catch(error => {
                    alert('上传失败，请重试！');
                    progressWrapper.classList.add('hidden');
                });
        }
        function getData() {
            const url = '/images';
            const tableBody = document.querySelector('#recordTable tbody');
            // 清空表格数据
            tableBody.innerHTML = '';
            axios.get(url)
                .then(response => {
                    const records = response.data;
                    records.forEach(record => {
                        const { name, address } = record;

                        const row = document.createElement('tr');
                        row.classList.add('border-b', 'border-opacity-20', 'border-gray-300', 'bg-gray-50');

                        const nameCell = document.createElement('td');
                        nameCell.classList.add('p-3');
                        nameCell.textContent = name;
                        row.appendChild(nameCell);

                        const addressCell = document.createElement('td');
                        addressCell.classList.add('p-3');
                        addressCell.textContent = address;
                        row.appendChild(addressCell);

                        tableBody.appendChild(row);
                    });
                })
                .catch(error => {
                    alert('获取数据失败，请重试！');
                });
        }

        // 异步请求页面进入时的数据
        window.addEventListener('DOMContentLoaded', () => {
            getData()
        });
    </script>
</body>
</html>
